<html lang="en">
<head>
    <title>Simple Shamirs Secrets Sharing tool</title>
    <style>
        div, input {margin: 8px 4px}
        td {padding: 2px 4px;vertical-align: text-bottom;}
        label {font-weight: bold}
        li {height: 24px; padding-bottom: 4px}
        .container {border: 1px dashed;padding: 0 12px}
        .break {word-break: break-all;}
    </style>
    <script
        src="https://cdn.jsdelivr.net/npm/secrets.js-grempe@2.0.0/secrets.min.js"
        integrity="sha256-IdClV+UScD6vegrlG4DrMTR6Y5F6kU+MIAeSePSkFcI="
        crossorigin="anonymous"
    ></script>
</head>
<body>
<div class="container">
    <h1>Simple Shamirs Secrets Sharing tool</h1>
    <p>Using <a href="https://github.com/grempe/secrets.js">secrets.js-grempe</a></p>
    <p><a href="https://en.wikipedia.org/wiki/Shamir%27s_secret_sharing">Shamirs Secret on Wikipedia</a></p>
    <h2>Settings</h2>
    <table>
        <tr>
            <td><label for="shares-input">Shares</label></td>
            <td><input type="number" id="shares-input" value="3" min="2" max="255"></td>
        </tr>
        <tr>
            <td><label for="shares-threshold-input">Shares threshold</label></td>
            <td><input type="number" id="shares-threshold-input" value="2" min="2" max="255"></td>
        </tr>
    </table>

    <div style="display: flex; width: 100%">
        <div id="split-container" class="container" style="width: 50%">
            <h3>Split</h3>
            <label for="split-secret-input">Secret to split</label>
            <input type="text" id="split-secret-input" value="secret">
            <ul id="split-shares-list"></ul>
        </div>
        <div id="combine-container" class="container" style="width: 50%">
            <h3>Combine</h3>
            <label>Input shares</label>
            <ol id="combine-shares-list"></ol>
            <label>Combined secret result: </label><div id="combined-result"></div>
        </div>
    </div>
</div>
<script type="text/javascript">
  const elements = {
    sharesInput: document.getElementById('shares-input'),
    sharesThresholdInput: document.getElementById('shares-threshold-input'),
    sharesList: document.getElementById('split-shares-list'),
    combineShareInputFieldsList: document.getElementById('combine-shares-list'),
    combinedResult: document.getElementById('combined-result'),
    combineShareInputs: []
  }
  let data = {
    secret: 'secret',
    shares: 3,
    threshold: 2
  }

  const showShares = shares => {
    elements.sharesList.innerHTML = null
    shares.map(share => {
      const listItem = document.createElement('li')
      listItem.classList.add('break')
      listItem.appendChild(document.createTextNode(share))
      elements.sharesList.appendChild(listItem)
    })
  }

  const generateSharesInputFields = () => {
    elements.combineShareInputFieldsList.innerHTML = null
    for (let i = 0; i < data.shares; i++) {
      const listItem = document.createElement('li')
      const input = document.createElement('input')
      input.type = 'text'
      input.id = `share-${i + 1}`
      input.classList.add('share-input')
      input.style.width = '100%'
      input.addEventListener('input', combine)
      listItem.appendChild(input)
      elements.combineShareInputFieldsList.appendChild(listItem)
    }
  }

  const split = () => {
    const hexedSecret = secrets.str2hex(data.secret)
    const shares = secrets.share(hexedSecret, data.shares, data.threshold)
    showShares(shares)
  }

  const combine = () => {
    const els = document.getElementsByClassName('share-input')
    const shares = []
    for (let i = 0; i < els.length; i++)
      if (els.item(i).value)
        shares.push(els.item(i).value)

    try {
      const hexedRestoredSecret = secrets.combine(shares)
      const restoredSecret = secrets.hex2str(hexedRestoredSecret)
      elements.combinedResult.innerText = restoredSecret
    } catch (e) {
      elements.combinedResult.innerText = e
    }
  }

  document.getElementById('split-secret-input').addEventListener('input', e => {
    data.secret = e.currentTarget.value
    split()
  })

  elements.sharesInput.addEventListener('input', e => {
    const value = Number.parseInt(e.currentTarget.value);
    if (value < data.threshold) {
      console.log('You cannot create less shares than you require for restoration, falling back to previous number')
      elements.sharesInput.value = data.shares
      return;
    }
    data.shares = value
    split()
    generateSharesInputFields()
  })

  elements.sharesThresholdInput.addEventListener('input', e => {
    const value = Number.parseInt(e.currentTarget.value);
    if (value > data.shares) {
      console.log('You cannot require more shares for restoration than you created, falling back to previous number')
      elements.sharesThresholdInput.value = data.threshold
      return;
    }
    data.threshold = value
    split()
  })

  split()
  generateSharesInputFields()
</script>
</body>
</html>
